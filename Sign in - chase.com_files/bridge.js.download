define(["require","exports","module","blue/compose","blue/declare","blue/event","blue/event/channel","blue/event/channel/domEvents","blue/log","blue/is","blue/util","blue/util","blue/util","blue/util","blue/as/contextual","blue-view/nodeDictionary","blue/perf","path-toolkit"],(function(e,t,n){"use strict";var i=e("blue/compose"),r=e("blue/declare"),o=e("blue/event"),a=e("blue/event/channel"),c=e("blue/event/channel/domEvents"),u=e("blue/log"),p=e("blue/is"),s=e("blue/util").object.deepEquals,l=e("blue/util").object,d=e("blue/util").object.merge,v=e("blue/util").array.flatten,m=e("blue/as/contextual"),g=e("blue-view/nodeDictionary"),f=e("blue/perf"),b=e("path-toolkit"),w=u("[blue:view:ractive]"),h=new b({simple:!0}),y=new b({simple:!1}),E=Object.assign({batchUpdateDefault:!1},n.config()),_={UPSTREAM:1,BOTH:1},O={DOWNSTREAM:1,BOTH:1},j=0,U=function(e){if(!e||"@"!==e[0])return e;var t,n,i=(/\{[^@}]+}/.exec(e)||["{}"])[0],r=(/\.([^}]+)$/.exec(e)||[])[1],o=function(e){try{return JSON.parse(e)}catch(e){return{}}}(i.replace(/[^\s,:{}]+/g,(function(e){return'"'===e[0]?"":'"'+e+'"'})));return(r?o[r]:(n=0,Object.keys(o).forEach((function(e){var i=o[e].split(".").length;i>n&&(n=i,t=e)})),t&&o[t].split(".").splice(0,n-1).join(".")))||""},D=function(e,t,n){var i,r=[];return n.forEach((function(n){var o,a=n+"",c=(a.match(/^((window|document|body|element|event)\.).+$/)||[])[1]||"",u=null;(u=C.prototype._makeEventDataCallback(e,t,n))?r.push(u):(c&&(a=a.replace(c+".","")),(o=y.getTokens(a))&&(i=function(e,t){var n={window:window,document:document,body:document.body},i=e.domEvent||void 0;if(t){if(n[t])return n[t];if(i)switch(t){case"element":return i.target;case"event":return i;case"$event":return}}}(e,c)||t,"function"==typeof(u=y.get(i,o))?r.push(u()):void 0===u?r.push(null):r.push(u)))})),r},C=function(e,t){var n=this;n.defineContext(t,{logger:u("[bridge:"+e+"]")}),n.name=e,n.id="<#"+n.name+"Bridge:"+ ++j+">",n.listeners={},n.queue=[],n.output=new a({eventTarget:n}),n.downstreamOutput=new a({eventTarget:n}),n.__enabled=!1,n.eventUnlisteners=[];var i=n.output.asEventStream(),r=i.onValue((function(e){n.__enabled&&!n.queueOutput||n.queue.push(e)}));i.onEnd(r),Object.defineProperty(n,"enabled",{get:function(){return n.__enabled},enumerable:!0}),f.count.call({id:n.id,ref:n},"blue/reactiveBridge","create",n.name)};return C.prototype=Object.create(null),C.prototype.constructor=C,C.prototype._makeEventDataCallback=function(){},C.prototype.define=function(e,t){i(this,t=t||{}),this.spec=d({bindings:{v:{}},triggers:{}},e)},C.prototype.createBinding=function(e){var t,n=this,i=n.spec.bindings[e];if(!p.plainObject(i))throw new TypeError('The mapping for target "'+e+'" is not valid');i.direction=(i.direction||"DOWNSTREAM").toUpperCase(),i.field=t=i.field||e,_[i.direction]&&(n.eventUnlisteners.push(n.view.rtemplate.observe(t,(function(e,t,i){n._fromComp||e===t||n.output.emit("binding",{value:U(i),data:e})})).cancel),(p.undefined(n.view.model[t])||null===n.view.model[t]||p.array(n.view.model[t])||p.plainObject(n.view.model[t]))&&(n.eventUnlisteners.push(n.view.rtemplate.observe(t+".*",(function(e,i,r){var o=n.view.model[t];n._fromComp||!p.array(o)&&!p.plainObject(o)||e===i||n.output.emit("binding",{value:U(r),data:e})})).cancel),n.eventUnlisteners.push(n.view.rtemplate.observe(t+".*.*",(function(e,i,r){var o=n.view.model[t];!n._fromComp&&p.array(o)&&p.plainObject(o[0])&&e!==i&&n.output.emit("binding",{value:U(r),data:e})})).cancel)))},C.prototype.createTrigger=function(e){var t=this,n=t.spec.triggers[e]||{},i=n.action||e||"",r=!1,a=!1,u=function(e,i,c,u,p,s){var l,d;return!r&&(!a&&(n.suspend&&(r=!0,setTimeout((function(){r=!1}),n.suspend)),"number"==typeof n.throttle&&(a=!0,setTimeout((function(){a=!1}),n.throttle)),e.nonCustomerEvent=!t.view.root._userEventRunning,n.args&&(d=D(e,t.view.model,n.args)).push(e),e.domEvent&&("preventDefault"in n?n.preventDefault&&e.domEvent.preventDefault():t.spec.preventDefault&&e.domEvent.preventDefault(),"stopPropagation"in n?n.stopPropagation&&e.domEvent.stopPropagation():t.spec.stopPropagation&&e.domEvent.stopPropagation()),"component"===c?(l=new o(e.domEvent,{type:"trigger",value:i,data:d||[e]}),t.output.emit(l)):"view"!==c||!t.view[u]||t.view[u].constructor!==Function||"onReady"===u&&"render"===s||t.view[u].apply(t.view,d||[e]),"render"!==s&&void 0))};(Array.isArray(i)?i.concat():[i]).forEach((function(n){var i=n.split("."),r=i[1]?i[0]:"component",o=i[1]?i[1]:i[0],a=e.split(":"),s=a[1]||"",l=a[0],v={};if(!o)throw new TypeError('The mapping for target "'+e+'" is not valid');!s||"window"!==l&&"document"!==l?(v["*."+l]=v[l]=function(e){var i,a;if(i=e&&e.context&&e.domEvent?e:e?{context:e.context?d({},e.context):e,dataPath:U(e.keypath),domEvent:e.original}:{},!s||i.domEvent&&i.domEvent.type===s)return i.domEvent&&(t.view.root._userEventRunning=!0),a=u(i,n,r,o,0,l),i.domEvent&&(t.view.root._userEventRunning=!1),a},p.defined(t.view.rtemplate)&&p.defined(t.view.rtemplate.on)?("teardown"===l?t.eventUnlisteners.push(t.view.rtemplate.on("teardown",v.teardown).cancel):t.eventUnlisteners.push(t.view.rtemplate.on(v).cancel),t.view._rendered&&v.render&&p.function(v.render)&&v.render.call(t)):p.defined(t.view.rtemplate)&&(t.view.rtemplate._triggers=t.view.rtemplate._triggers?t.view.rtemplate._triggers:[],t.view.rtemplate._triggers.push({event:l,action:v}))):t.eventUnlisteners.push(c.on((function(e){var i;if(e.type===s&&(e.target===document&&"document"===l||e.target===window&&"window"===l))return t.view.root._userEventRunning=!0,i=u({dataPath:null,context:d({},t.view.model),domEvent:e.originalEvent},n,r,o,0,l),t.view.root._userEventRunning=!1,i})))}))},C.prototype.addComponentSpecData=function(e){var t=this;!e||!t.spec.defaultBindings&&Object.keys(t.spec.bindings||{}).length>(t.spec.bindings.v?1:0)||(t.spec.bindings||(t.spec.bindings={}),Object.getOwnPropertyNames(e).forEach((function(e){t.spec.bindings[e]||(t.spec.bindings[e]={direction:"DOWNSTREAM"})})))},C.prototype.addComponentSpecSettings=function(e){var t=this;e&&(t.spec.bindings||(t.spec.bindings={}),Object.getOwnPropertyNames(e).forEach((function(e){"_init"!==e&&(t.spec.bindings[e]||(t.spec.bindings[e]={direction:"DOWNSTREAM"}))})))},C.prototype.addComponentSpecActions=function(e){var t=this;e&&(t.spec.triggers||(t.spec.triggers={}),Object.keys(e).forEach((function(e){t.spec.triggers[e]||(t.spec.triggers[e]={action:e,preventDefault:t.spec.preventDefault||!1,stopPropagation:t.spec.stopPropagation||!1})})))},C.prototype.disable=function(){var e,t,n=this;if(n.__enabled){for(n.__enabled=!1,f.count.call({id:n.id},"blue/reactiveBridge","destroy",n.name),n.view.parent||n.output&&n.output.emit("destroy"),n.output&&n.output.destroy(),n.pipedInputUnplugger&&n.pipedInputUnplugger(),t=v(n.eventUnlisteners);e=t.pop()||t.length;)p.function(e)?e():w.warn("["+n.view.context.getStack()+"]","Bridge disable - unexpected non-function found in eventUnlisteners array for "+n.view.viewName);n.downstreamOutput&&n.downstreamOutput.destroy(),n.listeners={},n.context&&n.destroyContext(),delete n.input,delete n.output,delete n.eventUnlisteners,delete n.spec,delete n.view}},C.prototype.reBind=function(e,t,n,i){this.input?this.pipedInputUnplugger=this.input.plug(e.asEventStream()):(this.addComponentSpecData(t),this.addComponentSpecSettings(n),this.addComponentSpecActions(i),this.enable(e))},C.prototype.enable=function(e){var t,n={},i={},r={},o=[r],a=this,c={};if(a.input=e,p.plainObject(a.spec)&&(a.view.isRoot()&&p.plainObject(a.spec.bindings)&&p.defined(a.view.rtemplate.observe)&&(Object.keys(a.spec.bindings).forEach(a.createBinding,a),Object.keys(a.spec.bindings).forEach((function(e){O[a.spec.bindings[e].direction]&&(c[e]=!0)})),a.output.emit("init",{downstream:c}),a.spec.batchUpdate="batchUpdate"in a.spec?a.spec.batchUpdate:E.batchUpdateDefault,a.on("data/*",(function(e){var c,u,p=e.value,l=(a.spec.bindings[p]||{}).direction,d={};O[l]&&(!i[p]&&s(e.current,a.view.model[p])||(e.path?(d[p]=e.current,c=h.get(d,e.path),u=e.path.split(".")[0]):(c=e.current,u=p),a.spec.batchUpdate?(n[u]&&(n={},r={},o.push(r)),n[u]=i[u]=!0,r[e.path||p]=c,t=t||setTimeout((function(){a._fromComp=!0,o.forEach((function(e,t){var n=f.count.call({bucket:"render"},"blue-view-ractive/bridge","batch",a.spec.name||a.name,t,Object.keys(e).length),i=function(e){var t=Object.keys(e).reverse(),n={};return t.forEach((function(t){n[t]=e[t]})),n}(e);try{a.view.rtemplate.set(i)}catch(e){w.error("Exception thrown when calling rtemplate.set for "+(a.spec.name||a.name),e)}n()})),n={},i={},o=[r={}],t=0,delete a._fromComp}),0)):(a._fromComp=!0,a.view.rtemplate.set(e.path||p,c),delete a._fromComp),f.count("blue/reactiveBridge","change",a.name,e.path||p)))})),a.on("reset/data",(function(e){var t,n={},i=a.spec.bindings,r=e.current;for(t in a._fromComp=!0,i)O[i[t].direction]&&(n[t]=r[t]);a.view.rtemplate.set(n),delete a._fromComp,f.count("blue/reactiveBridge","reset",a.name)}))),p.plainObject(a.spec.triggers)&&Object.keys(a.spec.triggers).forEach((function(e){a.createTrigger(e)})),!a.spec.triggers.render)){var u={render:function(){return!1}};p.defined(a.view.rtemplate)&&p.defined(a.view.rtemplate.on)&&a.eventUnlisteners.push(a.view.rtemplate.on(u).cancel),p.defined(a.view.rtemplate)&&(a.view.rtemplate._triggers=a.view.rtemplate._triggers?a.view.rtemplate._triggers:[],a.view.rtemplate._triggers.push({event:"render",action:u}))}var l,d=Object.keys(a.listeners);if(d.length&&d.forEach((function(e){(l=a.listeners[e]).forEach((function(t){a.on(e,t)})),l.clear()})),a.listeners={},a.view.isRoot()&&a.on("componentInputReady",(function(){for(a.queueOutput=!1;a.queue.length;){var e=a.queue.shift();"binding"!==e.type&&a.output.emit(e)}})),!a.view.isRoot()){var v=a.output.asEventStream(),m=v.onValue((function(e){var t=a.root;w.warn("["+a.view.context.getStack()+"]","DEPRECATED:BLUEJS-2297: Subview communicating directly to component"),t&&t.__enabled&&a.output.emit.call(a.root.output,e)}));v.onEnd(m)}a.on("destroyView",(function(e){(a.__enabled?g.destroyView(a.view):Promise.resolve()).catch((function(){})).then((function(){e.compDestroyResolve&&e.compDestroyResolve()}))})),a.__enabled=!0},C.prototype.on=function(e,t){var n=this;p.defined(n.input)?(!p.string(e)&&p.object(e)&&l.map(e,(function(t,n){var i=n.split("/").join("/");e[i]=t,delete e[n]})),n.eventUnlisteners.push(n.input.on(e,t))):(p.defined(n.listeners[e])||(n.listeners[e]=new Set),!n.listeners[e].has(t)&&n.listeners[e].add(t))},C.prototype.create=function(e,t,n){return p.undefined(n)&&(n=Object.create(null)),n.spec=e,n.view=t,r(C,n)},C=m.call(C,{name:"bridge"})}));