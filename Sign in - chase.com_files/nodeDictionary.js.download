define(["require","blue/dom","blue/is","blue/store/weakMemory","blue/as/serializable","blue/log"],(function(e){"use strict";var t=e("blue/dom"),r=e("blue/is"),o=e("blue/store/weakMemory"),n=e("blue/as/serializable"),i=new(e("blue/log"))("[nodeDictionary]"),s=function(e){var o=r.array(e)?e[0]:e;return r.string(o)?t.querySelector(o):o};function u(){this.store=new o("node")}return u.prototype.hasViewAt=function(e){var r=t.querySelectorAll(e),o=r[0];return 1===r.length?this.store.has(o):(r.length,!1)},u.prototype.getViewAt=function(e){var r,o=t.querySelectorAll(e),n=o[0];if(1===o.length&&this.store.has(n))return r=1===(r=this.store.get(n)).length?r[0]:r},u.prototype.add=function(e,t){var r,o,n,u=s(e);if(!u)throw o=t.name.split(t.viewName)[0].slice(0,-1),t._componentStack&&(n=t._componentStack),i.warn('Could not create view in node "'+e+'". Node not found in DOM.'),t._destroy(),n?new Error('Could not create-view in controller "'+o+'" for component "'+n+'" in node "'+e.selector+'". Node not found in DOM.'):new Error('Could not create-view in controller "'+o+'" in node "'+e.selector+'". Node not found in DOM.');u.setAttribute("data-has-view","true"),(r=this.store.get(u)||[]).push(t),this.store.set(u,r)},u.prototype.destroy=function(e){var t=this,r=[],o=s(e);return o?((t.store.get(o)||[]).forEach((function(e){r.push(t.destroyView(e))})),Promise.all(r).then((function(){o.removeAttribute("data-has-view"),t.store.remove(o)}))):Promise.resolve()},u.prototype.destroyView=function(e){var t,r,o,n,s,u,a=this,l=e.viewName||"(unknown)",c=[],h=new Promise((function(e,t){n=e,s=t})),d=e.target?e.target:null,f=function(t){return t!==e};return e.element&&d&&a.store.has(d)&&a.store.get(d).indexOf(e)>-1?(r=function(e){var t;return e?(t=Array.from(e.querySelectorAll("[data-has-view]")),e.getAttribute("data-has-view")&&t.push(e),t):[]}(e.element),"function"==typeof(u=Array.from(r).map((function(e){var t=[];return e&&a.store.has(e)&&(a.store.get(e).forEach((function(e){t.push((function(){return e._destroy()}))})),e.removeAttribute("data-has-view"),a.store.remove(e)),function(){return Promise.all(t.map((function(e){return e()})))}})).reduceRight((function(e,t){return t?e.then(t()).catch((function(e){throw e})):e}),Promise.resolve()))&&(u=u()),u.then((function(){d?(t=a.store.get(d))&&(1===t.length&&t[0]===e?(c.push(e._destroy()),d.removeAttribute("data-has-view"),a.store.remove(d)):t.length>1&&(o=t.filter(f),c.push(e._destroy()),a.store.set(d,o))):c.push(e._destroy()),Promise.all(c).then((function(){n()})).catch((function(e){i.error("Error encountered when destroying a top-level view "+l,e),s(e)}))})).catch((function(e){throw i.error("Error encountered when destroying a nested view within "+l,e),e}))):(d?(t=a.store.get(d))&&(1===t.length&&t[0]===e?(c.push(e._destroy()),d.removeAttribute("data-has-view"),a.store.remove(d)):t.length>1&&(o=t.filter(f),c.push(e._destroy()),a.store.set(d,o))):c.push(e._destroy()),Promise.all(c).then((function(){n()})).catch((function(e){i.error("Error encountered when destroying a top-level view "+l,e),s(e)}))),h},n.call(u.prototype,(function(){return"NodeDictionary"})),new u}));