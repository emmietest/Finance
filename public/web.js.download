define(["require","blue/as/contextual","blue/as/registry","blue/util","../resolver/cav","blue/deferred","blue/dom","blue/event/channel","blue/log","blue/is","../load","../nodeDictionary","blue/queue","blue/resolver/module","blue/root","blue/siteData","emitter-js"],(function(t){"use strict";var n,i=t("blue/as/contextual"),r=t("blue/as/registry"),o=t("blue/util").object.deepClone,a=t("../resolver/cav"),c=t("blue/deferred"),l=t("blue/dom"),s=t("blue/event/channel"),u=t("blue/log"),d=t("blue/is"),p=t("../load"),v=t("../nodeDictionary"),f=t("blue/queue"),m=t("blue/resolver/module"),g=t("blue/root"),b=t("blue/siteData"),w=t("emitter-js").default,h=u("[blue:view]"),y=g.performance&&g.performance.now&&g.performance.mark,x={},V={ractive:{path:"blue-view-ractive/view",deferred:void 0},vue:{path:"blue-view-vue/view",deferred:void 0}},k="ractive",E={},O=function(e,t,i){var r,o,a={alert:"once",when:"visible",percent:50,duration:0,event:"blue:dom:visibility",handler:function(){}},c=function(e,t){var n=t?">"+t:"",i=e,r=0;if(e.id)return"#"+e.id+n;if(!e.parentNode)return e.tagName+n;if((e.nextSibling||e.previousSibling||{}).tagName===e.tagName){for(;i=i.previousSibling;)r++;return c(e.parentNode,e.tagName+":nth-child("+r+")"+n)}return c(e.parentNode,e.tagName+n)},s=function(e,t,i){var r=n.context;e&&e.removeAttribute("trackVisibility"),r&&h.error("["+r.getStack()+"]",i+" ["+t.data+"]")},u=function(e){switch(e.when){case"visible":return e.isVisible;case"hidden":return!e.isVisible}return!0},d=function(e,t){var r,o,a=function(e,t){var n=e.getAttribute("trackVisibility")||'{"default": true}';try{n=JSON.parse(n)}catch(t){s(e,{data:e.id},"Unable to parse trackVisibility value"),n={}}return{alert:n.alert||t.alert,when:n.when||t.when,percent:Math.max(1,Math.min(100,n.percent||t.percent)),duration:Math.max(n.duration||t.duration),event:n.event||t.event,isVisible:n.isVisible||!1,selector:n.selector||c(e),data:n.data}}(e,n);if(!t||!E[a.selector]){if(r=a.isVisible,o=function(e){var t,n,i=e.getBoundingClientRect(),r=Math.ceil(.1*(i.bottom-i.top)),o=Math.ceil(.1*(i.right-i.left)),a=window.innerWidth||document.documentElement.clientWidth,c=window.innerHeight||document.documentElement.clientHeight,l=function(t,n){return e.contains(document.elementFromPoint(t,n))};return i.top>c||i.left>a||i.right<0||i.bottom<0||!(l(Math.max(i.left+o,0),Math.max(i.top+r,0))||l(Math.min(i.right-o,a),Math.max(i.top+r,0))||l(Math.max(i.left+o,0),Math.min(i.bottom-r,c))||l(Math.min(i.right-o,a),Math.min(i.bottom-r,c)))?0:(t=(i.bottom-i.top)*(i.right-i.left),n=(Math.min(i.bottom,c)-Math.max(i.top,0))*(Math.min(i.right,a)-Math.max(i.left,0)),Math.round(n/t*100))}(e),a.isVisible=o>=a.percent,a.duration&&a.isVisible){if(!r)return a.isVisible=Date.now()+a.duration,e.setAttribute("trackVisibility",JSON.stringify(a)),setTimeout((function(){d(e,t)}),a.duration);if(r.constructor===Number&&r>Date.now())return}switch(a.alert){case"once":if(!u(a))return;t&&(E[a.selector]=!0),e.removeAttribute("trackVisibility");break;case"every":if(a.isVisible===r)return;if(e.setAttribute("trackVisibility",JSON.stringify(a)),!u(a)||!a.isVisible&&r.constructor===Number)return;break;default:return void s(e,a,"Invalid trackVisibility alert attribute")}!function(e,t,r){var o,a=(i.context||{}).children||[],c=a.length,l={selector:t.selector,isVisibile:t.isVisible,data:t.data};if(r)try{n.handler(l)}catch(n){s(e,t,n.message)}if(!t.default)for(;c--;)if((o=a[c].element)&&o.contains(e))return a[c].emit(t.event,l)}(e,a,t)}},p=function(e){e?(g.addEventListener("resize",f,!1),g.addEventListener("scroll",f,!1)):(g.removeEventListener("resize",f,!1),g.removeEventListener("scroll",f,!1)),o=e},v=function(e,t){for(var n,i=document.querySelectorAll(e),r=n=i.length;r--;)d(i[r],t);return n},f=function(){r||(r=setTimeout((function(){var e,t=Date.now(),i=(n.selector?v(n.selector,!0):0)+v("[trackVisibility]");!i&&o&&p(!1),i&&!o&&p(!0),r=void 0,(e=Date.now()-t)>50&&n.context&&h.warn("["+n.context.getStack()+"]","Visibility tracking took "+e+"ms to check "+i+" elements!")}),250))};i.constructor!==Object&&(i={}),Object.keys(a).forEach((function(e){e in i||(i[e]=a[e])})),i.context=e,n||(g.MutationObserver?new g.MutationObserver(f).observe(l,{childList:!0,subtree:!0}):g.addEventListener("DOMNodeInserted",f,!1)),n=i,f()},S=function(e,t,n){var i,r,o,a=Object.create(null),c=!0;function l(e){if(d.defined(e)&&d.plainObject(e)&&e&&d.defined(e.actions)&&d.plainObject(e.actions)&&e.actions)for(o in e.actions)a[o]=e.actions[o]}if(n.length){if(i=t[e.spec.name],d.defined(i)&&d.plainObject(i)&&i)for(r=0;r<n.length;r++)l(i[n[r]])}else l(e.spec);for(o in e.spec.actions)c=c&&a[o];return c&&(a[e.spec.name]=!0),a},j=function(e,t){var n=t[0]&&t[0].context&&t[0].context.viewEngine?t[0].context.viewEngine:e;return t[1]&&t[1].viewEngine&&(n=t[1].viewEngine),t[2]&&t[2].viewEngine&&(n=t[2].viewEngine),n},R=function(e,t,n){var i=t.link(),r=e.spec||{};return(n=n||{}).linkToPage=!0,i.bridge.addComponentSpecData(Object.keys(r.data||{}).reduce((function(e,t){return e[t]=1,e}),{})),i.bridge.addComponentSpecSettings(e.getSettingsValues()),i.bridge.addComponentSpecActions(e.getActionNames()),n.viewInternals=i,{resolved:Promise.resolve([e,t,n])}},A=function(e){var t=e.destroy;e.destroy=function(n){return n?t.call(e):Promise.reject(new Error("Warning: Page view's component was told to destroy. This component may not be destroyed."))}},L=function(e,t){var n=this;n.name=e,w(n),n.defineContext(t,{name:e,pageName:e,logger:u("[Page-"+e+"]"),viewResolver:new m,screen:Object.create(null,{hasViewAt:{value:v.hasViewAt.bind(v),enumerable:!0},getViewAt:{value:v.getViewAt.bind(v),enumerable:!0}}),env:Object.create(t.env||null),pageReady:new Promise((function(e){"loading"===l.readyState?l.addEventListener("DOMContentLoaded",e):e()}))}),Object.defineProperties(n.context.site.env,{onLine:{get:function(){return g.navigator.onLine},enumerable:!0},print:{value:function(){g.print()},enumerable:!0}}),Object.defineProperties(n.context.env,{scrollToTop:{value:function(e){e?(e.scrollTop=0,e.scrollLeft=0):g.scrollTo(0,0)},enumerable:!0}}),n.tellApp=void 0,n.context.getViewRegistry=function(e){return new Promise((function(t,n){V[e]?V[e].deferred.promise.then((function(){t(V[e].registry)})):n()}))},n.context.on("application:display",(function(e){var t,i=[],r=e.contextStack,c=e.resolverPathOptions||o(n.context.viewResolverOptions)||{};!e.resolverPathOptions&&e.areaName&&(c.prefix=c.prefix||"",c.prefix=c.prefix+e.areaName+"/"),e.viewEngine||(e.viewEngine=k),d.array(e.cavList)?d.array(e.cavList[0])||d.plainObject(e.cavList[0])?e.cavList.forEach((function(o){"PAGE"===o[1]&&o[0]?(A(o[0]),i.push(R(o[0],n.pageView,o[2]))):(t=j(e.viewEngine,o),n.loadViewEngine(t),i.push(new a(n.context,t,x,o,r,c)))}),n):"PAGE"===e.cavList[1]&&e.cavList[0]?(A(e.cavList[0]),i.push(R(e.cavList[0],n.pageView,e.cavList[2]))):(t=j(e.viewEngine,e.cavList),n.loadViewEngine(t),i.push(new a(n.context,t,x,e.cavList,r,c))):d.plainObject(e.cavList)&&i.push(new a(n.context,e.viewEngine,x,e.cavList,r,c)),i.length||(n.context.emit("blue:route:viewRenderComplete",{msgType:"blue:route:viewRenderComplete",id:e.routeId,displayReqId:e.displayReqId,contextPath:e.contextStack,cavList:"",timestamp:y?performance.now():0,name:"blue:route:viewRenderComplete view "+e.contextStack+" "+e.displayReqId}),e.resolve&&e.resolve()),n.insertComponentView(e.controllerAction,i,e.activityChannel).then((function(t){n.context.emit("blue:route:viewRenderComplete",{msgType:"blue:route:viewRenderComplete",id:e.routeId,displayReqId:e.displayReqId,contextPath:e.contextStack,cavList:t,timestamp:y?performance.now():0,name:"blue:route:viewRenderComplete view "+e.contextStack+" "+e.displayReqId}),e.resolve&&e.resolve()}),(function(t){n.context.emit("blue:route:viewRenderComplete",{msgType:"blue:route:viewRenderComplete",id:e.routeId,displayReqId:e.displayReqId,contextPath:e.contextStack,cavList:"",timestamp:y?performance.now():0,name:"blue:route:viewRenderComplete view "+e.contextStack+" "+e.displayReqId}),e.reject&&e.reject(t)}))})),n.context.on("application:ready",(function(){n.context.on("page:error",(function(e){n.tellApp("page:error",e)})),n.context.on("blue:route:viewRenderComplete",(function(e){n.tellApp(e.msgType,e)}))})),n.context.on("importer:registerView",(function(e){var t=e.contextStack+"/"+e.viewName;x[t]=e.viewPath})),n.clearSelectorsConfig=null,n.context.on("clearSelectors",(function(){n.clearSelectors()})),this.constructorLegacyCallback.call(this)};function C(e,t){return(e&&e.context?e.context.getStack():"")+"+"+(t?t.name:"")}return L.prototype=Object.create(w.prototype),L.prototype.constructor=L,L.prototype.constructorLegacyCallback=function(){},L.prototype.destroy=function(){n=void 0,d.function(this.onDestroy)&&this.onDestroy(),w.prototype.destroy.call(this),this.destroyContext()},L.prototype.loadViewEngine=function(e){var t=this;e&&V[e]&&(V[e].deferred||(V[e].deferred=new c,g.requirejs([V[e].path],(function(n){V[e].deferred.resolve(n),r.call(V[e],"view",n,{lazy:!0,noCache:!0}),V[e].defineViewsRegistry(t.context)}),(function(e){context.error(e)}))))},L.prototype.insertComponentView=function(t,n,i){var r,a,c,u,p,m,g=this,b=[];return a=n.map((function(e){if(e)return e.resolved})),r=Promise.all(a),c=a.length,u=new Promise((function(e,t){p=e,m=t})),r.then((function(n){var r=new f("sync");n.forEach((function(a,u){r.add((function(r){var f,w,y,x,V,k,E=a[0],O=a[1],j=a[2],R=E&&E.context||{},A={},L=[],P=function(){var e,t,n;E?E.destroyed?setTimeout((function(){v.destroyView(O)}),0):(E._("enabled")&&E.disable(),j.viewInternals.bridge.enable(E.output),!E.__used&&i&&(E.__used=!0,e=E.output.asEventStream(),t=i.plug(e),e.onEnd(t)),E.enable(j.viewInternals.bridge.output)):(n=new s({eventTarget:j.viewInternals.bridge}),j.viewInternals.bridge.queueOutput=!0,j.viewInternals.bridge.enable(n)),r(),b.push(C(E,O)),u+1>=c&&p(b.join(","))};return E&&E.destroyed||O&&O.destroyed?(r(),b.push(C(E,O)),void(u+1>=c&&p(b.join(",")))):(j.target?f=j.target:R.viewTargeter&&(f=R.viewTargeter.targetRequest(t,O.viewName)),f&&!j.append&&(L=function(e){var t,n=e||l;return d.string(e)&&(n=l.querySelector(e)),t=n&&n.querySelectorAll("[data-component-name]")||[],Array.prototype.map.call(t,(function(e){return e.getAttribute("data-component-name").split("|")[3]}))}(f),n.forEach((function(e){e[0]&&L.includes(e[0]._("guid"))&&(e.keepAlive=e[0]._("keepAlive"),e[0]._("keepAlive",!0))}))),void(j.linkToPage?(O.model.roles=S(E,g.roledata,g.userType),E._queueData=!0,x=E.spec||{},V=Object.keys(x.data||{}).reduce((function(e,t){return e[t]=1,e}),{}),k=O.rtemplate.get(),E.destroyed||(E._("enabled")&&E.disable(),Object.keys(k).forEach((function(e){V[e]&&E.model.set(e,k[e])})),j.viewInternals.bridge.reBind(E.output,V,E.getSettingsValues(),E.getActionNames()),!E.__used&&i&&(E.__used=!0,w=E.output.asEventStream(),y=i.plug(w),w.onEnd(y)),E.enable(j.viewInternals.bridge.output)),r(),u+1>=c&&p(b.join(","))):f?(d.plainObject(j.model)&&(O.model=g.context.util.object.mixIn(O.model,o(j.model))),E&&(Object.keys(E.spec.data||{}).forEach((function(e){A[e]=void 0})),O.model=g.context.util.object.mixIn(A,O.model,E.model.get({isolate:!0}),E.getSettingsValues()),O.model.roles=S(E,g.roledata,g.userType),E._queueData=!0),(j.append?Promise.resolve():v.destroy([f])).then((function(){E&&E._("keepAlive",a[0].keepAlive),j.append?O.appendTo(f,P):O.replaceIn(f,P)}),(function(e){throw h.error("["+g.context.getStack()+"]","View(s) in target node "+f+" failed to destroy",e),g.context.page.emit("page:error",{code:"blue:app:error:nodeDestroyFailed",description:"View(s) in target node "+f+" failed to destroy; "+e.name+":"+e.message}),e})).catch((function(e){var t=E?E.spec.name:"NONE",n=j.append?"appended":"rendered";h.error("["+g.context.getStack()+"]","CAV ("+t+":"+O.viewName+") could not be "+n+" to target "+f,e),g.context.page.emit("page:error",{code:j.append?"blue:app:error:cavAppendFailed":"blue:app:error:cavInsertFailed",description:"CAV ("+t+":"+O.viewName+") could not be "+n+" to target "+f+"; "+e.name+":"+e.message}),r(),u+1>=c&&m(e)}))):(h.error("["+g.context.getStack()+"]",O.viewName+" has no render target specified"),r(),u+1>=c&&m(e))))}))}))}),(function(e){h.error("["+g.context.getStack()+"]","CAV List could not be resolved:",e),g.context.page.emit("page:error",{code:"blue:app:error:cavListResolutionFailed",description:"CAV List could not be resolved:"+e}),m(e)})),u},L.prototype.loadSpec=function(){var e,t,n,i,r=this,o=new Promise((function(n,i){e=n,t=i}));return p((n="",(i=(l.location.hash||"").replace("#","").split("/")).length&&i[0]?n=i[0]:g.appRoutes&&g.appRoutes[0]&&(n=g.appRoutes[0]),n),(function(n){r.settings=n,r.roledata=n.roles||Object.create(null),r.userType=[];var i=b.getData("userType");if(d.defined(i)&&i&&(d.string(i)||d.array(i))){var o=[],c=!0;d.string(i)&&(i=[i]);for(var l=0;l<i.length;l++)d.undefined(i[l])||!i[l]||"PrimaryUser"===i[l]?c=!1:o.push(i[l]);c&&(r.userType=o)}n.viewResolverOptions&&(r.context.viewResolverOptions=n.viewResolverOptions||{}),n.viewEngine?r.view&&r.loadViewEngine(n.viewEngine):(n.viewEngine=k,r.view&&r.loadViewEngine(k)),n.context&&Object.keys(n.context).forEach((function(e){r.context[e]=n.context[e]})),r.context.pageReady.then((function(){if(r.view){var i,o=r.viewTarget||"body";r.loadViewEngine(n.viewEngine),(i=new a(r.context,n.viewEngine,x,[void 0,r.view,{target:o}],r.context.getStack())).resolved.then((function(e){r.pageView=e[1]})),r.trackVisibility&&i.resolved.then((function(){O(r.context,0,r.trackVisibility)})),r.insertComponentView("page.root",[i]).then(e,t)}else e()}))})),o},L.prototype.clearSelectors=function(){var e=this.clearSelectorsConfig,t=function(e){var t=e||"";for(t=t.replace(/^#/,"");t.indexOf(";")>-1;)t=t.replace(/;[^\/]*/,"");for(;t.indexOf("//")>-1;)t=t.replace("//","/");return"/"!==(t=t.replace(/\?.*$/,""))[0]&&(t="/"+t),t}(l.location.hash),n=[];return e&&d.plainObject(e)?(Object.keys(e).forEach((function(i){if(Object.hasOwnProperty.call(e,i)){var r=Array.isArray(e[i])?e[i]:[e[i]];(function(e,t){var n;return n=(n=t.split("/").map((function(e){return"*"===e&&(e="[^/]*"),e})).join("/")).replace(/\/\*\*/g,"(/[^/]+)*"),new RegExp(`^${n}$`).test(e)})(t,i)&&r.forEach((function(e){n.push(v.destroy(e))}))}})),Promise.all(n)):Promise.resolve()},L=i.call(L,{name:"page"})}));